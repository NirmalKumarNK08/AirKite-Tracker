<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Display a map</title>
  <script src="https://cdn.maptiler.com/maplibre-gl-js/v2.4.0/maplibre-gl.js"></script>
  <link href="https://cdn.maptiler.com/maplibre-gl-js/v2.4.0/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="./style/map.css">
</head>
<body>
  <!-- Header contents -->
   <header>
      <div class="navigation">
         <h1 class="logo">AirKite Tracker</h1>
         <div class="nav-contents">
            <ul>
               <li><a href="./index.html">Home</a></li>
               <li><a href="./map.html">Map</a></li>
               <li><a href="./flightSchedules.html">Schedules</a></li>
               <li><a href="./about.html">About</a></li>
            </ul>
         </div>
      </div>
   </header>
  <div id="map">
    <div id="card" class="active">
      <div class="cardContents">
        <div class="close-icon">
          <span class="cls-icon">
            <button id="close-icon"><ion-icon name="close-outline"></ion-icon></button>
          </span>
        </div>

        <!-- head -->
        <div class="head">
          <div class="img-content">
            <img class="icon-logo" src="https://daisycon.io/images/airline/?width=130&height=70&iata=6e" alt="logo">
          </div>
          <div class="plane-names">
            <h1>Indigo </h1>
            <h3>AB123</h3>
          </div>
        </div>

        <!-- origin-destination -->
        <div class="org-dest">
          <div class="org">
            <h3>Chennai</h3>
            <h1>MAA</h1>
            <h3>20:00</h3>
          </div>
          <div class="org-dest-logo">
            <img src="./images/flight-path.png" alt="flightpath">
          </div>
          <div class="dest">
            <h3>Delhi</h3>
            <h1>DEL</h1>
            <h3>12:40</h3>
          </div>
        </div>

        <div class="card-container">
          <!-- speed-altitude -->
          <div class="speed-altitude">
            <div class="s-a-head">
              <ion-icon class="speed-icon" name="speedometer-outline"></ion-icon>
              <h2>Speed & Altitude</h2>
            </div>
            <div class="s-a-contents">
              <div class="hs">
                <h3>H-Speed:&ensp;</h3> <p style="font-weight: bold;"> 530kts</p>
              </div>
              <div class="vs">
                <h3>V-Speed:&ensp;</h3> <p style="font-weight: bold;"> 0.5</p>
              </div>
              <div class="al">
                <h3>Altitude:&ensp;</h3> <p style="font-weight: bold;"> 500</p>
              </div>
            </div>
          </div>

          <!-- direction -->
          <div class="direction">
            <div class="d-head">
              <ion-icon class="dir-icon" name="compass-outline"></ion-icon>
              <h2>Direction & Status</h2>
            </div>
            <div class="d-contents">
              <div class="dir">
                <h3>Direction:&ensp;</h3> <p style="font-weight: bold;"> 270deg</p>
              </div>
              <div class="sts">
                <h3>Status:&ensp;</h3> <p style="font-weight: bold;"> Scheduled</p>
              </div>
            </div>
          </div>

          <!-- latitude & longitude -->
          <div class="lat-long">
            <div class="ll-head">
              <ion-icon class="ll-icon" name="globe-outline"></ion-icon>
              <h2>Latitude & Longitude</h2>
            </div>
            <div class="d-contents">
              <div class="long">
                <h3>Longitude:&ensp;</h3> <p style="font-weight: bold;">20.157290</p>
              </div>
              <div class="lat">
                <h3>Latitude:&ensp;</h3> <p style="font-weight: bold;">-9.1345260</p>
              </div>
              <div class="squa">
                <h3>Squawk:&ensp;</h3> <p style="font-weight: bold;">6542</p>
              </div>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
  <script
    src="https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"
    charset="utf-8"></script>
  <script>
    const card = document.getElementById("card");
    const close_icon = document.getElementById("close-icon");
    const geojson = {
      'type': 'FeatureCollection',
      'features': []
    };
      const key = 'MPTXvKHskAzZTasuqjks';
      const map = new maplibregl.Map({
        container: 'map', // container's id or the HTML element in which MapLibre GL JS will render the map
        style: `https://api.maptiler.com/maps/hybrid/style.json?key=${key}`, // style URL
        center: [16.62662018, 49.2125578], // starting position [lng, lat]
        zoom: 1, // starting zoom
      });
      
      var longitude, latitude, rotate, description;
      var lati, longi, dire, des;
      let arrayOfObjects = [];

      var arr = [
          [20.157290, 30.033527, 45, "AB123"],
          [30.157290, 40.033527, 90, "AB123"],
          [40.157290, 50.033527, 20, "AB123"],
          [50.157290, 60.033527, 190, "AB123"],
          [60.157290, 70.033527, 270, "AB123"]
      ]

      console.log(arr)

      function creategeoJSONobject(data) {
          for(let i=0; i<arrayOfObjects.length; i++) {
            if(arrayOfObjects[i][0] == undefined ||
               arrayOfObjects[i][2] == undefined ||
               arrayOfObjects[i][3] == undefined ||
               arrayOfObjects[i][3] == undefined) {
              i++;
            } else {
              longitude = arrayOfObjects[i][0];
              latitude = arrayOfObjects[i][1];
              rotate = arrayOfObjects[i][2];
              flight_iata = arrayOfObjects[i][3];
              geojson.features.push(passer(longitude, latitude, rotate));
            }
          }
          
          function passer(longitude, latitude, rotate) {
            return (
              {
                'type': 'Feature',
                'properties': {
                  'iconSize': [35, 35]
                },
                'geometry': {
                  'type': 'Point',
                  'coordinates': [longitude, latitude],
                  'rotation': rotate
                }
              }
            )
          }
        console.log(geojson)
        geojson.features.forEach(function (marker) {
          // create a DOM element for the marker
          var el = document.createElement('div');
          el.className = 'marker'
          el.style.width = marker.properties.iconSize[0] + 'px';
          el.style.height = marker.properties.iconSize[1] + 'px';
          
          el.addEventListener('click', function () {
            card.classList.remove("active");
          });
          
          // add marker to map
          var markerIcon = new maplibregl.Marker(el)
          .setLngLat(marker.geometry.coordinates)
          .addTo(map);

          markerIcon.setRotation(marker.geometry.rotation);
        });

          close_icon.addEventListener('click', () => {
          card.classList.add("active");
        })
      }

      const xhr = new XMLHttpRequest();
      xhr.open('GET', 'https://airlabs.co/api/v9/flights?api_key=3ded0fe9-727b-4ec1-835c-3343dda21a95');
      xhr.responseType = 'json';
      xhr.onload = function() {
        if (xhr.status === 200) {
          const data = xhr.response.response;
          // console.log(data);
          for(let i=0; i<data.length; i++) {
            longi = data[i].lng;
            lati = data[i].lat;
            dire = data[i].dir;
            des = data[i].flight_iata;
            var flight = [`${longi}`,`${lati}`, `${dire}`, `${des}`];
            arrayOfObjects.push(flight);
          }
          console.log(arrayOfObjects);
        } else {
          console.log('Unable to load JSON data');
        }
        creategeoJSONobject(arrayOfObjects);
      };
      xhr.send();

      //  var coordinate1 = new maplibregl.Marker({
      //    color: "#000",
      //    draggable: false
      // }).setLngLat([80.157290, 13.033527]).addTo(map);

      // var coordinate2 = new maplibregl.Marker({
      //    color: "#000",
      //    draggable: false
      // }).setLngLat([10.5, 20.5]).addTo(map);
      
      // var new_york = new maplibregl.LngLat(-74.0060, 40.7128);
      // var los_angeles = new maplibregl.LngLat(-118.2437, 34.0522);
      var c1 = coordinate1.getLngLat();
      var c2 = coordinate2.getLngLat();

      var origin = [c1.lng, c1.lat];
      var destination = [c2.lng, c2.lat];

      //Arc from origin to destination
      var route = {
        'type': 'FeatureCollection',
        'features': [
          {
            'type': 'Feature',
            'geometry': {
              'type': 'LineString',
              'coordinates': [origin, destination]
            }
          }
        ]
      };

      //Distance between two coordinates
      var lineDistance = turf.lineDistance(route.features[0], 'kilometers');
      console.log(lineDistance);

      var arc = [];
      //No. of steps used in the arc like if the steps are more
      //then the line looks smoother.
      var steps = 500;

      //Drawing the arc
      for (var i = 0; i < lineDistance; i += lineDistance / steps) {
        var segment = turf.along(route.features[0], i, 'kilometers');
        arc.push(segment.geometry.coordinates);
      }
      route.features[0].geometry.coordinates = arc;

      var counter = 0;

      map.on('load', function() {
        map.addSource('route', {
            'type': 'geojson',
            'data': route
        });

        map.addLayer({
            'id': 'route',
            'source': 'route',
            'type': 'line',
            'paint': {
                'line-width': 3,
                'line-color': '#ffff00'
            }
        });
      });
  </script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>